---
- name: Starting TestAPI
  become: "{{ ansible_connection is defined }}"
  community.docker.docker_container:
    name: testapi
    image: '{{ testapi_docker_image }}:{{ testapi_docker_tag }}'
    pull: '{{ docker_pull }}'
    recreate: '{{ docker_recreate }}'
    restart_policy: '{{ docker_restart_policy }}'
    published_ports:
      - '{{ testapi_port }}:8000'
    env:
      base_url: '{{ testapi_base_url }}'
      mongodb_url: '{{ mongo_url }}'
      auth: 'false'
    container_default_behavior: no_defaults
  notify:
    - Waiting TestAPI
  when:
    - testapi_deploy
    - become_tasks or ansible_connection is not defined
- name: Flushing handlers
  meta: flush_handlers
- name: Checking if pod is already registered
  uri:
    url: '{{ testapi_deploy_url }}/pods/{{ (item.values() | list).0.slave | default(node_name) }}'
    status_code:
      - 200
      - 404
  register: http_response
  loop: "{{ docker_tags }}"
  when:
    - testapi_deploy or testapi_configure
- name: Registering the pod
  uri:
    url: '{{ testapi_deploy_url }}/pods'
    method: POST
    body: {"name":"{{ (item.values() | list).0.slave | default(node_name) }}"}
    status_code: 200
    body_format: json
  loop: "{{ docker_tags }}"
  loop_control:
    index_var: loop_idx
  when:
    - testapi_deploy or testapi_configure
    - http_response.results[loop_idx].status != 200
- name: Checking if project is already registered
  uri:
    url: '{{ testapi_deploy_url }}/projects/{{ item.db_project|default(db_project) }}'
    status_code:
      - 200
      - 404
  register: http_response
  loop: "{{ suites }}"
  when:
    - testapi_deploy or testapi_configure
- name: Registering the project
  uri:
    url: '{{ testapi_deploy_url }}/projects'
    method: POST
    body: {"name":"{{ item.item.db_project | default(db_project) }}"}
    status_code:
      - 200
      - 403
    body_format: json
  with_items:
    - '{{ http_response.results }}'
  when:
    - testapi_deploy or testapi_configure
    - item.status != 200
- name: Checking if testcase is already registered
  uri:
    url: "{{ testapi_deploy_url }}/projects/{{
      item.0.db_project |default(db_project) }}/cases/{{ item.1 }}"
    status_code:
      - 200
      - 404
  with_subelements:
    - '{{ suites }}'
    - 'tests'
  register: http_response
  when:
    - testapi_deploy or testapi_configure
- name: Registering the testcases
  uri:
    url: "{{ testapi_deploy_url }}/projects/{{
      item.item.0.db_project |default(db_project) }}/cases"
    method: POST
    body: {"name":"{{ item.item.1 }}"}
    status_code: 200
    body_format: json
  with_items:
    - '{{ http_response.results }}'
  loop_control:
    label: "{{ item.item.1 }}"
  when:
    - testapi_deploy or testapi_configure
    - item.status != 200
